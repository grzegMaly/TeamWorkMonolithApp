package com.mordiniaa.backend.repositories.mysql;

import com.mordiniaa.backend.security.model.RefreshTokenEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.time.Instant;

@Repository
public interface RefreshTokenRepository extends JpaRepository<RefreshTokenEntity, Long> {

    @Modifying
    @Query(value = """
            update refresh_tokens old
            join refresh_token_families family on family.id = :familyId
            set old.revoked = true,
                old.revoked_at = :revokedAt,
                family.revoked = true,
                family.revoked_at = :revokedAt
            where old.id = :tokenId
            """, nativeQuery = true)
    void deactivateTokenWithFamily(Long tokenId, Long familyId, Instant revokedAt);

    @Modifying(flushAutomatically = true, clearAutomatically = true)
    @Query(value = """
            update refresh_tokens old
            join refresh_tokens new on new.id = :newTokenId
            set old.replaced_by_id = new.id,
                old.revoked = true,
                old.revoked_at = :revokedAt
            where old.id = :oldTokenId
            """, nativeQuery = true)
    void rotateToken(Long newTokenId, Long oldTokenId, Instant revokedAt);
}
